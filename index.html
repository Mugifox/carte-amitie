<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dernier d√©tenteur de la carte</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .card { max-width: 640px; padding: 16px 20px; border: 1px solid #ddd; border-radius: 12px; }
    .title { font-size: 1.4rem; font-weight: 800; margin-bottom: 10px; }
    .line  { font-size: 1.05rem; margin: 6px 0; }
    .muted { color: #555; font-size: 0.96rem; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-top: 14px; }
    a.button, button { text-decoration:none; border:1px solid #333; padding:10px 14px; border-radius:10px; cursor:pointer; background:#fff; }
  </style>
</head>
<body>
  <div class="card">
    <div class="title">Dernier d√©tenteur de la carte</div>
    <div id="status" class="muted">Chargement‚Ä¶</div>

    <div id="last" class="line" hidden></div>
    <div id="when" class="muted" hidden></div>      <!-- Date (fran√ßais) -->
    <div id="delta" class="muted" hidden></div>     <!-- √âcart relatif -->
    <div id="motif" class="line" hidden></div>      <!-- Motif s√©par√© -->

    <div class="row">
      <a id="formLink" class="button" href="#" rel="noopener" target="_blank">Remplir le formulaire</a>
      <button id="refreshBtn" type="button">Rafra√Æchir</button>
    </div>
  </div>

  <script>
  // üëâ REMPLACE ICI :
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxVPvYiecC55amcyKuySt5rNPpAx7-_dZLY1KEOSCLvfc-hFcBtJFbi-Ds6zxuzWALV/exec';
  const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSeYjFDKHRhFwvze41lS2bojxuMd0kSOl-MLBDtn4EFPw53IGA/viewform?usp=header';

  // ------------------ helpers ------------------
  const $ = (sel) => document.querySelector(sel);

  // Date FR lisible
  const fmtDateFR = (ms) => {
    if (!ms) return '‚Äî';
    return new Intl.DateTimeFormat('fr-FR', { dateStyle: 'full', timeStyle: 'medium' })
             .format(new Date(ms));
  };

  // √âcart relatif (jours/heures/minutes)
  function relativeFR(fromMs, toMs = Date.now()) {
    if (!fromMs) return '';
    const diff = Math.max(0, toMs - fromMs);
    if (diff < 60 * 1000) return "√† l‚Äôinstant";

    let r = diff;
    const J = 24*60*60*1000, H = 60*60*1000, M = 60*1000;
    const jours   = Math.floor(r / J); r %= J;
    const heures  = Math.floor(r / H); r %= H;
    const minutes = Math.floor(r / M);

    const s = (n, sing, plur) => n + ' ' + (n > 1 ? plur : sing);
    const parts = [];
    if (jours) parts.push(s(jours, 'jour', 'jours'));
    if (jours || heures) parts.push(s(heures, 'heure', 'heures'));
    parts.push(s(minutes, 'minute', 'minutes'));

    return 'il y a ' + parts.join(', ');
  }

  // R√©cup√®re un timestamp ms √† partir du payload
  function getMsFromPayload(data) {
    if (typeof data?.timestampMs === 'number') return data.timestampMs;
    if (typeof data?.horodateur === 'number')  return data.horodateur;
    if (typeof data?.horodateur === 'string')  return Date.parse(data.horodateur) || null;
    if (typeof data?.iso === 'string')         return Date.parse(data.iso) || null;
    return null;
  }

  const render = (data) => {
    const status = $('#status');
    const last   = $('#last');
    const when   = $('#when');
    const delta  = $('#delta');
    const motif  = $('#motif');

    if (data.empty) {
      status.textContent = "Aucune entr√©e pour l‚Äôinstant.";
      last.hidden = when.hidden = delta.hidden = motif.hidden = true;
      return;
    }

    status.textContent = "";
    last.hidden = when.hidden = delta.hidden = motif.hidden = false;

    const ms = getMsFromPayload(data);

    last.textContent  = `üë§ ${data.detenteur || data.name || 'Inconnu'}`;
    when.textContent  = `üïí ${fmtDateFR(ms)}`;
    delta.textContent = relativeFR(ms);
    motif.textContent = `üìù Motif : ${data.motif || '‚Äî'}`;
  };

  // -------- fetch JSON normal puis repli JSONP --------
  const fetchJSON = async () => {
    const url = `${WEB_APP_URL}?action=last&_t=${Date.now()}`;
    const res = await fetch(url, { credentials: 'omit' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  };

  const fetchJSONP = () => new Promise((resolve, reject) => {
    const cbName = '__onLast_' + Math.random().toString(36).slice(2);
    window[cbName] = (payload) => { resolve(payload); cleanup(); };
    const s = document.createElement('script');
    s.src = `${WEB_APP_URL}?action=last&callback=${cbName}&_t=${Date.now()}`;
    s.onerror = () => { reject(new Error('JSONP error')); cleanup(); };
    document.body.appendChild(s);
    function cleanup(){ delete window[cbName]; s.remove(); }
  });

  async function load() {
    $('#formLink').href = GOOGLE_FORM_URL;
    $('#status').textContent = 'Chargement‚Ä¶';
    try {
      render(await fetchJSON());
    } catch {
      try { render(await fetchJSONP()); }
      catch { $('#status').textContent = "Impossible de charger les infos."; }
    }
  }

  $('#refreshBtn').addEventListener('click', load);
  document.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>
